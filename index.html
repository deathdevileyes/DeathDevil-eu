<script>
/* ===== SERVER CONFIG ===== */
const STATUS_IP = "134.255.220.222:2200";
const JOIN_IP   = "gray-crocodile-04861.zap.cloud";
const MAX_SLOTS = 4;

/* ===== ELEMENTS ===== */
const playersEl = document.getElementById("players");
const stateEl   = document.getElementById("state");
const dot       = document.getElementById("dot");
const pingEl    = document.getElementById("ping");
const versionEl = document.getElementById("version");
const motdEl    = document.getElementById("motd");

/* ===== STATUS FETCH (JAVA 1.21.5) ===== */
async function fetchStatus(){
  try{
    const start = performance.now();
    const res = await fetch(
      "https://api.mcstatus.io/v2/status/java/" + STATUS_IP
    );
    const data = await res.json();
    const ping = Math.round(performance.now() - start);

    if(!data.online) throw "offline";

    /* Online */
    stateEl.textContent = "Online";
    dot.classList.add("online");

    playersEl.textContent = data.players.online;
    versionEl.textContent =
      data.version && data.version.name_clean
        ? data.version.name_clean
        : "Java";

    pingEl.textContent = ping;
    pingEl.style.color =
      ping < 80 ? "#00ff00" :
      ping < 150 ? "#ffd700" : "#ff5555";

    /* MOTD (ohne optional chaining!) */
    if (data.motd && data.motd.clean && data.motd.clean.length > 0) {
      motdEl.textContent = data.motd.clean.join(" ");
    } else {
      motdEl.textContent = "Willkommen auf DeathDevil.eu";
    }

    updateChart(data.players.online);

  } catch (e) {
    stateEl.textContent = "Offline";
    dot.classList.remove("online");
    playersEl.textContent = "0";
    pingEl.textContent = "–";
    versionEl.textContent = "–";
    motdEl.textContent = "Server aktuell offline";
    updateChart(0);
  }
}

setInterval(fetchStatus, 5000);
fetchStatus();

/* ===== GRAPH (FEHLERFREI) ===== */
const ctx = document.getElementById("chart").getContext("2d");
let history = new Array(30).fill(0);

function updateChart(val){
  history.push(val);
  history.shift();

  ctx.clearRect(0, 0, 600, 200);
  ctx.beginPath();
  ctx.strokeStyle =
    getComputedStyle(document.body).getPropertyValue("--accent");

  ctx.moveTo(0, 200 - history[0] * 40);

  for(let i = 1; i < history.length; i++){
    ctx.lineTo(i * 20, 200 - history[i] * 40);
  }

  ctx.stroke();
}

/* ===== COPY IP ===== */
function copyIP(){
  navigator.clipboard.writeText(JOIN_IP);
  alert("IP kopiert: " + JOIN_IP);
}

/* ===== NEON TOGGLE ===== */
function toggleMode(){
  document.body.classList.toggle("neon");
  localStorage.setItem(
    "mode",
    document.body.classList.contains("neon")
  );
}

if(localStorage.getItem("mode") === "true"){
  document.body.classList.add("neon");
}
</script>
